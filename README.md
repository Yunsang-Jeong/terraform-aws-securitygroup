# Overview

Terraform module for AWS Security group, which aims to focus on actual service operations.



The module has the following characteristics:

- You can provision multiple security groups and rules at one time.
- Individual `identifier`  are entered into each security group, ingress, and egress rule to apply `lifecycle { create_before_destroy = true}`.
- There is a caution when using `cidr_blocks`, `ipv6_cidr_blocks`, and `prefix_list_ids` in `aws_security_group_rule`. 
  If there is a change in `cidr_blocks`, the `aws_security_group_rule` itself is replaced (delete and create), not just the changed part. This can cause an issue in service operation. Therefore, `aws_security_group_rule` is created by separating the items of `cidr_block` individually (This is the same for `ipv6_cidr_blocks` and `prefix_list_ids`.).



If `var.security_groups` is too long, please consider writing it in yaml or json file and using `yamldcode()` or `jsondecode()`.



The contents below are generated by `terrform-docs`.

<!-- BEGIN_TF_DOCS -->
## Providers

| Name | Version |
|------|---------|
| <a name="provider_aws"></a> [aws](#provider\_aws) | >= 4.40.0 |

## Requirements

| Name | Version |
|------|---------|
| <a name="requirement_terraform"></a> [terraform](#requirement\_terraform) | >= 1.3.0 |
| <a name="requirement_aws"></a> [aws](#requirement\_aws) | >= 4.40.0 |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_default_tags"></a> [default\_tags](#input\_default\_tags) | Default tags for all resources. | `map(string)` | `{}` | no |
| <a name="input_name_tag_convention"></a> [name\_tag\_convention](#input\_name\_tag\_convention) | The name tag convention of all resources. | <pre>object({<br>    project_name = string<br>    stage        = string<br>  })</pre> | <pre>{<br>  "project_name": "tf",<br>  "stage": "poc"<br>}</pre> | no |
| <a name="input_security_groups"></a> [security\_groups](#input\_security\_groups) | The security gorup information | <pre>list(object({<br>    identifier       = string<br>    description      = string<br>    name_tag_postfix = string<br>    additional_tag   = optional(map(string), {})<br>    ingresses = optional(list(object({<br>      identifier                       = string<br>      description                      = string<br>      from_port                        = string<br>      to_port                          = string<br>      protocol                         = string<br>      cidr_blocks                      = optional(list(string))<br>      ipv6_cidr_blocks                 = optional(list(string))<br>      prefix_list_ids                  = optional(list(string))<br>      source_security_group_identifier = optional(string)<br>      source_security_group_id         = optional(string)<br>      self                             = optional(bool)<br>    })), [])<br>    egresses = optional(list(object({<br>      identifier                            = string<br>      description                           = string<br>      from_port                             = string<br>      to_port                               = string<br>      protocol                              = string<br>      cidr_blocks                           = optional(list(string))<br>      ipv6_cidr_blocks                      = optional(list(string))<br>      prefix_list_ids                       = optional(list(string))<br>      destination_security_group_identifier = optional(string)<br>      destination_security_group_id         = optional(string)<br>      self                                  = optional(bool)<br>      })), [<br>      {<br>        identifier  = "default"<br>        description = "Default"<br>        from_port   = 0<br>        to_port     = 0<br>        protocol    = "-1"<br>        cidr_blocks = ["0.0.0.0/0"]<br>      }<br>    ])<br>  }))</pre> | `[]` | no |
| <a name="input_vpc_id"></a> [vpc\_id](#input\_vpc\_id) | The id of vpc where you want to place security group | `string` | n/a | yes |

## Outputs

| Name | Description |
|------|-------------|
| <a name="output_security_group_id_map"></a> [security\_group\_id\_map](#output\_security\_group\_id\_map) | The map of the security group id. |

## Example
```terraform
provider "aws" {
  region = "ap-northeast-2"
}

data "aws_vpc" "default" {
  default = true
}

module "this" {
  source = "../"

  vpc_id = data.aws_vpc.default.id
  security_groups = [
    {
      identifier       = "ec2-bastion"
      name_tag_postfix = "ec2-bastion"
      description      = "the security group for bastion host"
      ingresses = [
        {
          identifier  = "ssh-public"
          description = "SSH connection"
          from_port   = "22"
          to_port     = "22"
          protocol    = "tcp"
          cidr_blocks = ["1.2.3.4/32"]
        }
      ]
    },
    {
      identifier       = "elb-web"
      description      = "the security group for web-elb"
      name_tag_postfix = "elb-web"
      ingresses = [
        {
          identifier  = "web"
          description = "Web service"
          from_port   = "443"
          to_port     = "443"
          protocol    = "tcp"
          cidr_blocks = ["0.0.0.0/0"]
        }
      ]
      egresses = [
        {
          identifier                            = "health-check-to-web"
          description                           = "Health check"
          from_port                             = "80"
          to_port                               = "80"
          protocol                              = "tcp"
          destination_security_group_identifier = "ec2-web"
      }]
    },
    {
      identifier       = "ec2-web"
      name_tag_postfix = "ec2-web"
      description      = "the security group for web-elb"
      ingresses = [
        {
          identifier                       = "srv-web-elb"
          description                      = "Connection from elb"
          from_port                        = "80"
          to_port                          = "80"
          protocol                         = "tcp"
          source_security_group_identifier = "elb-web"
          }, {
          identifier                       = "ssh-from-bastion"
          description                      = "Connection from bastion"
          from_port                        = "22"
          to_port                          = "22"
          protocol                         = "tcp"
          source_security_group_identifier = "ec2-bastion"
        }
      ]
    },
    {
      identifier       = "vpc-endpoint"
      name_tag_postfix = "vpc-endpoint"
      description      = "the security group for vpc-endpoint"
      ingresses = [
        {
          identifier  = "https-itself"
          description = "itself"
          from_port   = "443"
          to_port     = "443"
          protocol    = "tcp"
          self        = true
        }
      ]
    }
  ]
}

output "security_group" {
  value = module.this
}
```
<!-- END_TF_DOCS -->
